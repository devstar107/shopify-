![App Header](public/images/app-readme@1024x.png)

# Events United Editions Stock Sync - Shopify App

A Shopify app based on Next.js making stocks live sync between a Shopify store and a Events United's Brand User possible.

* [Getting Started](#getting-started)
* [App Setup](#app-setup)
    * [Shopify Partners Dashboard](#shopify-partners-dashboard)
    * [.env file](#env-file)
    * [Languages](#languages)
* [Local testing](#local-testing)
    * [Prerequisites](#prerequisites)
* [Deployment](#deployment)
    * [App Installation](#app-installation)
* [Demo](#demo)
* [API Endpoints](#api-endpoints)
    * [Products / Options / Values](#products-options-values)
    * [Stocks](#stocks)
    * [Redis](#redis)
* [Built with](#built-with)
* [Authors](#authors)
* [License](#license)

## Getting Started

You can use this code to set up a local copy of the app, or to deploy it on your web server. Either way you will need to get a copy of this repository.

`git clone git@github.com:black924berry/eventunited.git`

## App Setup

To get your app up and running a few config will be necessary.

### Shopify Partners Dashboard

This part is only necessary if you wish to have the App setup on your own Shopify Partners Dashboard, else the app developper can handle that.

If you wish to obtain full access, first you need to create a [Shopify Partners Account](https://shopify.com/partners).

Then log in your partners dashboard. And follow [this doc](https://help.shopify.com/en/api/tutorials/build-a-shopify-app-with-node-and-react/embed-your-app-in-shopify#get-a-shopify-api-key-and-shopify-api-secret-key) to create some app credentials.

### .env file

To make your app work you will need to access `.env` file at the repository's root.

* Change the `SHOPIFY_API_KEY` and `SHOPIFY_API_SECRET` with the ones given in your dashboard.
* Change the `SHOPIFY_APP_URL` with the URL where your app is hosted. If you want to make it work locally you will need to paste your ngrok / pagekite autogenerated URL instead (see [Local testing](#local-testing)).
* Set `WITH_AUTHENTICATION` either to 'TRUE' OR 'FALSE' wether you want to access freely the API endpoints or if you want to secure them.

### Languages

This app is multilang ready. The language detection is automatic and is based on browser's accept-language param. 

You can find languages conf file at the root of the projet : `next-i18next.config.js` 

Every translations can be found there : `public/locales`

## Local testing

### Prerequisites

You need the latest stable version on [Node.js](https://nodejs.org/en/docs/)/[NPM](https://www.npmjs.com/) running on your machine.
You will also need to run a tunneling solution such as [ngrok](https://ngrok.com/) or [pagekite](https://pagekite.net/) (since [Shopify](https://shopify.com) is a self hosted CMS) to access your local app from your Shopify store.

If needed you can access the exhaustive Shopify docs [here](https://help.shopify.com/en/api/tutorials/build-a-shopify-app-with-node-and-react/embed-your-app-in-shopify).

Start by installing required dependencies. Get in repository's root. Open cmd.

```
ngrok http 3000
```

Then run your localhost tunnel, and in another cmd window start your app. 

```
npm install
```

```
npm run dev
```

Then access the app installation URL with your store URL (see [App Installation](#app-installation)).

## Deployment :rocket:

In order to put this app in production you will need a web server running on *[Node.js](https://nodejs.org/en/docs/)* allowing for *[React > 16](https://reactjs.org/)*.
It is recommended to use a server that does not goes in *"cold state"* so that app users will not have to wait too much too see their app load on Shopify admin.

You can use hosting provider such as *[Heroku]()*, *[Zeit.co]()*, *[Digital Ocean]()* or any providers of your choice meetings the dev requirements.

Your app will also need to be accessed exclusively through an **https** protocol.

On top of that, it is required to have a redis add-on so that you can store every shopify store's access token / picaflor access token.

### App Installation 

Every user willing to install this app will have to access a specific URL since the app will not be listed on the Shopify App Marketplace (or anywhere else actually).

Provide them this URL : `https://{YOURAPP.com}/auth?shop={STORENAME}.myshopify.com`

* `{YOURAPP.com}` = The domain where your app is hosted
* `{STORENAME}` = The name of the user's store (:warning: The store name is the one with the `.myshopify.com` that user can see once logged into his store admin and not the URL from the custom domain the user may have bought on top of shopify's one).

And voil√† !

## Demo

A Shopify dev store was set up. You can access it through this url : [https://ab-picaflor-editions.myshopify.com/admin](https://ab-picaflor-editions.myshopify.com/admin).

No demo logs are created, however you can request access by getting in touch with the developper at [hello@aurelienbobenrieth.fr](hello@aurelienbobenrieth.fr).

The app is already installed and accessible here : [https://ab-picaflor-editions.myshopify.com/admin/apps/picaflor-stocks-sync](https://ab-picaflor-editions.myshopify.com/admin/apps/EVENTSUNITED-stocks-sync).

The demo app is hosted on Heroku and is accesible here [https://ab-picaflor-editions.herokuapp.com/](https://ab-picaflor-editions.herokuapp.com/).

Anyone can install it with the (explained above) URL : `https://ab-picaflor-editions.herokuapp.com/auth/inline?shop={STORENAME}.myshopify.com` .

## API Endpoints

Several API endpoints have been set up so that some datas can be retrieved from stores that have installed the app.

If you want to access these endpoints outside the Shopify App interface, you will need to provide in each request header : 

`{ x-shopify-access-token : token }` (replacing token with the appropriate shopify access token)

### Products / Options / Values

* Get all products from a store (return `{ id, title, handle, images, variants [id, title, inventory_item_id, inventory_quantity, options] }`)
* You can add `?fields=stock` to also return the product & variants stock from the store's selected location (`selected_location_inventory_quantity`)

**GET** `/api/2021-05/{shop}/products`

* Get same data of the above endpoint but for a specific product
* You can add `?fields=stock` to also return the product & variants stock from the store's selected location (`selected_location_inventory_quantity`)

**GET** `/api/2021-05/{shop}/products/{product_id}`

* Get all options from products in a store (return an array of option names)

**GET** `/api/2021-05/{shop}/options`

* Get all option values from a specific option

**GET** `/api/2021-05/{shop}/options/{option}`

### Stocks

* Get a specific product stock

**GET** `/api/2021-05/{shop}/products/{inventoryItemId}/stock`

* Set a specific product stock

**PUT** `/api/2021-05/{shop}/products/{inventoryItemId}/stock`

* Manual synchronization for one product

**PUT** `/api/2021-05/{shop}/products/update`

* Create 'EventsUnited Integration' product

**PUT** `/api/2021-05/{shop}/products/create`

### Locations / Warehouses

* Get list of every store's locations

**GET** `/api/2021-05/{shop}/products/locations`

* Get store's selected location

**GET** `/api/2021-05/{shop}/products/selected-location`

* Set store's selected location

**PUT** `/api/2021-05/{shop}/products/selected-location`

### Redis store

* Get Events United to Shopify access token

**GET** `/api/2021-05/{shop}/redis/marketplace-token`

* Set Events United to Shopify access token

**PUT** `/api/2021-05/{shop}/redis/marketplace-token`



## Built With

* [Next.js](https://nextjs.org/docs) - A React SSR framework
* [Node.js](https://nodejs.org/en/docs/) - Server
* [Redis](https://redis.io/) - A simple Key/Value pairing data store
* [Shopify Polaris](https://polaris.shopify.com/components/get-started) - Design System
* [Shopify Koa](https://github.com/koajs/koa) - Middleware / Auth

## Authors

* **Events United Editions** - *End client* - [Events United Editions](https://www.eventsunited.net)

## License

This project is the exclusive property of **Events United Editions**. 
*The developper reserves the right to use samples of this code in other of his project, as it is either the source of public docs or his own intellectual property.*
